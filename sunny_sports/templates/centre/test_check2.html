
<div class="page-header"><h1>培训结果审核</h1></div>
<div class="row">
  <div class="col-xs-1"></div>
  <div class="col-xs-10">
    <div>
      <div>
        <div class="profile-info-name">培训编号</div>
        <div class="profile-info-value">{{train.id}}</div>
      </div>
      <div>
        <div class="profile-info-name">培训课程</div>
        <div class="profile-info-value">{{train.name}}</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-name">培训等级</div>
        <div class="profile-info-value">{{train.get_level_display}}</div>
      </div>
      <div class="profile-info-row">
        <div class="profile-info-name">培训机构</div>
        <div class="profile-info-value">{{train.org.org_name}}</div>
      </div>
    </div>
    <hr />
    <div>
      <table id="check-table" class="table table-striped table-bordered table-hover">
        <thead class="thin-border-bottom">
          <tr>
            <th class="center">
              <i class="ace-icon fa fa-user"></i>
              姓名 
            </th>
            <th class="center">学号</th>
            <th class="center">是否通过
            </th>
          </tr>
        </thead>

        <tbody>
          {% for i in c_t %}
          <tr>
            <td class="center" style="cursor:pointer"><span class="label label-inverse">{{i.coach.property.name}}</span></td>
            <td class="center">{{i.number}}</td>
            <td class="center">
              {{i.status}}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="row center">
        <button class="btn btn-success" id="pass-btn">通过并发布</button>
        <button class="btn btn-info" id="not-pass-btn">审批不通过</button>
      </div>
      <div class="col-xs-1"></div>
    </div>

    <script type="text/javascript" src="../../static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../../static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../static/js/bootbox.min.js"></script>
    <script type="text/javascript" src="../../static/js/jquery.cookie.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
        $('#pass-btn').click(function(){
          //生成编号
          var t_id = '{{ train.id }}';
          var c_t = '{{ c_t }}';
          var $m = '';
          var cert = {};
          $m += '<table class="table table-striped table-bordered table-hover">';
          $m += '<thead class="thin-border-bottom">';
          $m += '<tr> <th class="center"> <i class="ace-icon fa fa-user"></i>姓名</th>';
          $m += '<th class="center">学号</th>';
          $m += '<th class="center">是否通过</th>';
          $m += '<th class="center">证书编号</th>';
          $m += '</tr> </thead>';
          $m += '<tbody><tr>';
          $("#check-table tbody tr").each(function(i, e){
            if ($(e).find("td").last().html().trim() == "1"){ //通过的才有证书编号
              $m += $(e).html();
              var n = $(e).find("td:eq(1)").html().trim(); //获取学号
              $m += '</td><td class="center">'+ (t_id+n)+'</td>';
              cert[n] = t_id+n;
            }

          });
          $m += '</tr></tbody>';

          bootbox.dialog({
            message: $m,
            title: "证书编号生成",
            buttons: {
              success: {
                label: "确认并发布",
                className: "btn-success",
                callback: function() {
                  var csrftoken = $.cookie('csrftoken');
                  $.post('/centre/check_pass', 
                    {"pass":true,"t_id":"{{ train.id }}", 'csrfmiddlewaretoken': csrftoken, 'cert':cert},
                    function(data){
                      console.log(data["success"])
                    if (data["success"]){ //提交成功后
                      $.get('/centre/test_check', function(page){
                        $('.page-content').html(page); //返回审核列表页面
                        alert("已发布");
                      });
                    }
                  });
                }
              }
            }
          });

        });
        $('#not-pass-btn').click(function(){
          $.post(/centre/check_pass, {"pass":false, "t_id":"{{ train.id }}"},function(){
          });

        });

      });
    </script>
