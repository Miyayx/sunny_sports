
{% extends "./coach_org/base.html" %}
{% block content %}
{{ block.super }}
<div class="page-header"><h1>培训信息管理</h1></div>

<div class="row">
    <div class="col-sm-1"></div>
    <div class="col-sm-10">
        <div class="tabbable tabs-left">
            <ul class="nav nav-tabs" id="train-tab">
                {% for train, cts in zipped %}
                <li>
                <a data-toggle="tab" href="#{{train.id}}">
                    <i class="pink ace-icon fa fa-tachometer bigger-110"></i>
                    {{train.name}}
                </a>
                </li>
                {% endfor %}
            </ul>

            <div class="tab-content">
                {% for train, cts in zipped %}
                <div id="{{train.id}}" class="tab-pane">
                    <div class="profile-user-info profile-user-info-striped">
                        <div >
                            <div class="profile-info-name">培训ID</div>
                            <div class="profile-info-value">{{train.id}}</div>
                        </div>
                        <div>
                            <div class="profile-info-name">培训名称</div>
                            <div class="profile-info-value">{{train.name}}</div>
                        </div>
                        <div>
                            <div class="profile-info-name">培训等级</div>
                            <div class="profile-info-value">{{train.get_level_display}}</div>
                        </div>
                        <div>
                            <div class="profile-info-name">报名时间</div>
                            <div class="profile-info-value">{{train.reg_stime}}</div>
                        </div>
                        <div>
                            <div class="profile-info-name">开始时间</div>
                            <div class="profile-info-value">{{train.train_stime}}</div>
                        </div>
                        <div>
                            <div class="profile-info-name">培训地点</div>
                            <div class="profile-info-value">{{train.address}}</div>
                        </div>
                        <div>
                            <div class="profile-info-name">报名/上限人数</div>
                            <div class="profile-info-value">{{train.cur_num}}/{{train.limit}}</div>
                        </div>
                        <div>
                            <div class="profile-info-name">当前状态</div>
                            <div class="profile-info-value">
                                {% if train.reg_status == 0 %}
                                <span class="red">报名未开始</span>
                                {% elif train.reg_status == 1 %}
                                <span class="red">报名中</span>
                                {% elif train.reg_status == 2 and train.sub_status == 0 %}
                                <span class="red">培训中</span>
                                {% elif train.reg_status == 2 and train.sub_status == 2 %}
                                <span class="red">审核未通过</span>
                                {% elif train.reg_status == 2 and train.pub_status == 0 %}
                                <span class="red">等待结果审核</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div>
                        {% if train.reg_status == 2 and not train.sub_status == 1 %}
                        <h3>结果录入</h3>
                        {% else %}
                        <h3>班级信息</h3>
                        {% endif %}
                        <form>
                            {% csrf_token %}
                            <table id="checked-table" class="table table-striped table-bordered table-hover">
                                <thead class="thin-border-bottom">
                                    <tr>
                                        <th class="center">
                                            <i class="ace-icon fa fa-user"></i>
                                            学员 
                                        </th>
                                        <th class="center">学号</th>
                                        <!-- 报名期间不出现“是否通过”的列-->
                                        {% if train.reg_status == 2 and not train.sub_status == 1 %}
                                        <!-- 报名截止, 成绩结果未提交或审核不通过-->
                                        <th class="center">是否通过
                                            <br/>
                                            <input type="checkbox" class="ace check-all">
                                            <span class="lbl"></span>
                                        </th>
                                        {% elif train.reg_status == 2 and train.sub_status == 1 %}
                                        <!-- 报名截止, 且成绩结果已提交，等待中心审核-->
                                        <th class="center">是否通过
                                            <br/>
                                            <input type="checkbox" class="ace check-all" disabled="true">
                                            <span class="lbl"></span>
                                        </th>
                                        {% endif %}
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for ct in cts %}
                                    <tr>
                                        <td class="center"><a>{{ ct.coach.property.name }}</a></td>
                                        <td class="center">{{ct.number}}</td>
                                        {% if train.reg_status == 2 and not train.sub_status == 1 %}
                                        <!-- 报名截止, 成绩结果未提交或审核不通过-->
                                        <td class="center">
                                            {% if ct.status %}
                                            <input type="checkbox" checked="true" class="ace" name="{{ct.number}}">
                                            {% else %}
                                            <input type="checkbox" class="ace" name="{{ct.number}}">
                                            {% endif %}
                                            <span class="lbl"></span>
                                        </td>
                                        {% elif train.reg_status == 2 and train.sub_status == 1 %}
                                        <!-- 报名截止, 且成绩结果已提交，等待中心审核-->
                                        <td class="center">
                                            {% if ct.pass_status %}
                                            <input type="checkbox" checked="true" class="ace" name="{{ct.number}}" disabled="true">
                                            {% else %}
                                            <input type="checkbox" class="ace" name="{{ct.number}}" disabled="true">
                                            {% endif %}
                                            <span class="lbl"></span>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <div class="row center">
                                {% if train.cur_num > 0  %}
                                <a class="btn btn-success download-btn" href="/download?t_id={{train.id}}" target="_blank">下载Excel</a>
                                {% endif %}
                                {% if train.reg_status == 2 and not train.sub_status == 1 %}
                                <button class="btn btn-success save-btn">保存</button>
                                <button class="btn btn-info submit-btn">提交</button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div><!-- /.tab-pane -->
                {% endfor %}
            </div><!-- /.tab-content -->
        </div><!-- /.col-ms-10 -->
    </div><!-- /.row -->
    {% endblock %}

    {% block script %}
    <script type="text/javascript">
        window.onload = function() {
            if(location.hash){//if the page's URL has an octothore part
                t_id = location.hash.substr(1);
                $('li a[href="#'+t_id+'"]').parent().addClass("active");
                $('#'+t_id).addClass("active");
                //gets the checkbox's ID with the hash minus the octothorpe, and then checks it
            } else {
                //if there WASN't an octorthorpe
                $('#train-tab li:first').addClass("active");
                $('.tab-pane').first().addClass("active");
            }
        };

        $('.check-all').click(function () {    
            $(this).closest('form').find('input:checkbox').prop('checked', this.checked);    
        });

        $('.save-btn').click(function(e){
            e.preventDefault();
            var d = {"submit":0, //false 
                'csrfmiddlewaretoken': '{{csrf_token}}',
                't_id':$(this).closest('.tab-pane').attr('id')};
                $(this).closest('form').find('td input:checkbox').each(function(i,v){
                    d[$(v).attr("name")] = $(v).prop('checked');
                });
                $.post('/coach_org/score_input', d, function(data){
                    if(data['success']){
                        alert("已保存");
                    }else{
                        alert("保存失败，请重试");
                    }
                });
        });

        $('.submit-btn').click(function(e){
            e.preventDefault();
            var $btn = $(this);
            var d = {"submit":1, //true 
                'csrfmiddlewaretoken': '{{csrf_token}}',
                't_id':$(this).closest('.tab-pane').attr('id')};
                $(this).closest('form').find('td input:checkbox').each(function(i,v){
                    d[$(v).attr("name")] = $(v).prop('checked');
                });
                $.post('/coach_org/score_input', d, function(data){
                    if(data['success']){
                        $btn.closest('form').find('input:checkbox').attr("disabled",true);
                    }else{
                        alert("提交失败，请重试");
                    }
                });
        });

    </script>
    {% endblock %}
